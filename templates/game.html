{% extends "base.html" %}
{% block body %}
<div class="card">
  <h2 class="title">ê²Œì„ ì§„í–‰</h2>
  <div id="roleBox" class="li" style="background:#fff8fb">
    <div><span class="badge">ë‚´ ì—­í• </span> <b id="role">-</b></div>
    <div style="height:6px"></div>
    <div><span class="badge">ì£¼ì œ</span> <span id="topic">-</span></div>
    <div id="wordWrap" style="margin-top:6px;"><span class="badge">ì œì‹œì–´</span> <span id="word">-</span></div>
  </div>

  <div class="grid grid-2">
    <div class="score">
      <h3>í„´/íƒ€ì´ë¨¸</h3>
      <div>í˜„ì¬ ë‹¨ê³„: <span id="phase">-</span></div>
      <div style="height:6px"></div>
      <div class="timer" id="timer">00:00</div>
    </div>
    <div class="score">
      <h3>ì°¸ê°€ì</h3>
      <ul id="plist" class="list"></ul>
    </div>
  </div>

  <hr>
  <div id="voteArea" class="card" style="background:#fffdfa">
    <h3>ê³µê°œ íˆ¬í‘œ</h3>
    <div id="voteButtons"></div>
    <div style="height:8px"></div>
    <button id="submitVote" class="btn btn-outline">íˆ¬í‘œ ì œì¶œ</button>
  </div>

  <div id="guessArea" class="card" style="background:#f7fffb; display:none;">
    <h3>ë¼ì´ì–´ ìµœì¢… ì •ë‹µ ë§íˆê¸° (30ì´ˆ)</h3>
    <input id="guessInput" class="input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
    <div style="height:8px"></div>
    <button id="submitGuess" class="btn btn-primary">ì •ë‹µ ì œì¶œ</button>
  </div>

  <div class="center" style="margin-top:12px">
    <div class="pill">ë¼ìš´ë“œ <span id="round">-</span> / 5</div>
  </div>
</div>

<script>
const socket = io();
let myId = null;
let voted = null;
let amHost = false;

function mmss(sec){
  sec = Math.max(0, sec|0);
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

/* âœ… í˜ì´ì§€ ì§„ì… ì‹œ: ê³µìš© ë£¸ ì¬-ì¡°ì¸ í›„ ìŠ¤ëƒ…ìƒ· ìš”ì²­ */
socket.on('connect', ()=>{
  socket.emit('join', {
    name: "{{ session.get('name','') }}",
    host_code: "{{ session.get('host_code','') }}"
  });
});

socket.on('join_ok', (d)=>{
  amHost = !!d.is_host;
  socket.emit('sync_game');   // í˜„ì¬ ë¼ìš´ë“œ/ì—­í• /ì œì‹œì–´ ë“± ë°›ì•„ì˜¤ê¸°
});

socket.on('me', (d)=>{ myId = d.id; });

/* âœ… ì„œë²„ê°€ ë‚´ë ¤ì£¼ëŠ” ì „ì²´ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ í™”ë©´ êµ¬ì„± */
socket.on('game_info', (g)=>{
  document.getElementById('role').textContent  = g.me?.role ?? '-';
  document.getElementById('topic').textContent = g.topic ?? '-';
  document.getElementById('round').textContent = g.round ?? '-';

  const wordWrap = document.getElementById('wordWrap');
  const wordEl   = document.getElementById('word');
  if (g.me?.word){
    wordEl.textContent = g.me.word;
    wordWrap.style.display = 'block';
  } else {
    wordWrap.style.display = 'none';
  }

  const plist = document.getElementById('plist');
  plist.innerHTML = '';
  (g.players || []).forEach(p=>{
    const li = document.createElement('li');
    li.className='li';
    li.innerHTML = `${p.name} ${p.speaked? 'ğŸ—£ï¸':''} ${p.is_dead?'(íƒˆë½)':''}`;
    plist.appendChild(li);
  });

  document.getElementById('phase').textContent = g.phase_label || '-';
  document.getElementById('timer').textContent = mmss(g.seconds_left || 0);

  // íˆ¬í‘œ UI
  const voteArea    = document.getElementById('voteArea');
  const voteButtons = document.getElementById('voteButtons');
  const submitVote  = document.getElementById('submitVote');

  if (g.phase === 'VOTE' || g.phase === 'REVOTE'){
    voteArea.style.display = 'block';
    voteButtons.innerHTML = '';
    voted = g.my_vote || null;
    (g.players || []).filter(p=>!p.is_dead).forEach(p=>{
      const b = document.createElement('button');
      b.className = 'vote-btn' + (voted===p.id ? ' active':'');
      b.textContent = p.name;
      b.onclick = ()=>{
        voted = p.id;
        [...voteButtons.children].forEach(c=>c.classList?.remove('active'));
        b.classList.add('active');
      };
      voteButtons.appendChild(b);
      voteButtons.appendChild(document.createTextNode(' '));
    });
    submitVote.onclick = ()=>{
      if (!voted) return alert('í•œ ëª…ì„ ì„ íƒí•˜ì„¸ìš”!');
      socket.emit('submit_vote', {target_id: voted});
    };
  } else {
    voteArea.style.display = 'none';
  }

  // ë¼ì´ì–´ ì •ë‹µ ì œì¶œ
  const guessArea = document.getElementById('guessArea');
  if (g.phase === 'LIAR_GUESS' && g.me?.role==='LIAR'){
    guessArea.style.display = 'block';
  } else {
    guessArea.style.display = 'none';
  }
});

/* â± íƒ€ì´ë¨¸ í‹± */
socket.on('tick', (sec)=>{
  document.getElementById('timer').textContent = mmss(sec);
});

/* ğŸ”š ê²°ê³¼ í™”ë©´ ì´ë™ */
socket.on('move_results', ()=>{
  location.href = "{{ url_for('results') }}";
});

/* ì—ëŸ¬ íŒì—… */
socket.on('error_msg', (e)=>{
  alert(e?.msg || 'ì—ëŸ¬ê°€ ë°œìƒí–ˆì–´ìš”.');
});

/* ì •ë‹µ ì œì¶œ */
document.getElementById('submitGuess')?.addEventListener('click', ()=>{
  const val = document.getElementById('guessInput').value.trim();
  if (!val) return alert('ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!');
  socket.emit('liar_guess', {guess: val});
});
</script>
{% endblock %}
